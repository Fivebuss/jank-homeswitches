// Half-broken HomeWorldName-based HomeSwitch
// In theory this approach should be much, much better than renaming and moving things around. However, it is not without its MAJOR downsides, alongside the usual problems of HomeSwitches
// Set inside KSS2Settings.cfg 'HomeSwitch = Teshyr' to use, set it to False to remove

// !!!!!!!!!! VERY IMPORTANT
// Regarding the camera displacement bug: It seems that a save and unsave inside an active game session is required. 
// If we do not do this, (Ex: Load into tracking station then out again) theres a 50/50 chance severe problems will occur. Its basically gambling
// This issue is *not* fixable by me, without writing a .dll mod. I COULD maybe do that in the far future. Or kopernicus could fix it
// !!!!!!!!!!

@Kopernicus_config:HAS[@KSS2_Settings:HAS[#HomeSwitch[Teshyr]]]:BEFORE[KSS2]
{
    %HomeWorldName = Teshyr // Much better than PostOrbit
}

// We are disabling ondemand to fix the flashing orbit lines bug, and because its a switched homeworld, to attempt to curb trackingStation issues
@Kopernicus:HAS[@KSS2_Settings:HAS[#HomeSwitch[Teshyr]]]:AFTER[KSS2]
{
    @Body[Teshyr]
    {
        @ScaledVersion
        {
            @Material
            {
                texture = KSS2/SystemAethera/PluginData/Teshyr_Color1.dds
                normals = KSS2/SystemAethera/PluginData/Teshyr_Normal.dds
            }
            !OnDemand {}
		}
    }
}

@Kopernicus:HAS[@KSS2_Settings:HAS[#HomeSwitch[Teshyr]]]:AFTER[KSS2]
{
    removeLaunchSites = Desert_Launch_Site,Desert_Airfield,Desert_GroundObjects,Woomerang_Launch_Site,Woomerang_GroundObjects,Island_Airfield 
    Body[Kerbin]
    {
        @PQS
        {
            !Mods[MapDecalTangent,KSC] {}
        }
        // Attempt to strip SpaceCenter node from kerbin
        !SpaceCenter {}
    }

    // Teshyr
    @Body[Teshyr]
    {
		cacheFile = KSS2/SystemNovaKirbani/_Cache/TeshyrHS.bin
        @Properties
        {
            isHomeWorld = true // Help KSC scene bug
		}
		PostSpawnOrbit
		{
			referenceBody = #$../../Body[Teshyr]/Orbit/referenceBody$
		}
		//atmos mods go here

        // PQS nonsense, part 4
        @PQS
        {
            @Mods
            {
                MapDecalTangent
				{
					name = KSC
					absolute = True
					absoluteOffset = 1242 // I hate this
					angle = 120
					cullBlack = False
					DEBUG_HighlightInclusion = False
					heightMap = BUILTIN/ksc_decal_heightMap
					heightMapDeformity = 18 // Works well for teshyr
					removeScatter = False
					radius = 3150 // Radius of decal. Yet its a square. What?
                    position = 299817.531,7739.94385,-487066.25

					useAlphaHeightSmoothing = True
					enabled = True
					order = 450
                }

                // Parallax mask goes here

                // Derived from Blalo.cfg
                !MapDecalVertexRemoveScatter:HAS[#name[ParallaxMaskKSC]]
                MapDecalVertexRemoveScatter
                {
                    name = ParallaxMaskKSC
                    colorMap = KSS2/Core/Extras/HomeSwitch/KSCD.dds
                    debugColorMap = KSS2/Core/Extras/HomeSwitch/KSCD.dds
                    angle = -150 // Flip as the DDS file is flipped too
                    radius = 1650 // Same thing
                    position = 0.523986757,0.0138701601,-0.848613381 // Offset

                    
                    BlockedScatters
                    {
                        
                        // Yeah it goes here
                        name = SlabsSmall
                        name = SlabsMed
                        name = SlabsLarge
                        name = SmallRocksVar1
                        name = SmallRocksVar2
                        name = MedRocksVar1
                        name = MedRocksVar2
                        name = MedRocksVar3
                        name = SteepRocksMed
                        name = SteepRocksSmall
                        name = IceSlabsSmall
                        name = IceSlabsMed
                        name = IceSlabsLarge
                        name = Boulder
                        name = DesertCliff
                        name = UnderwaterSlabs
                        name = RockFormation1
                        name = RockFormation2
                    }
                    

                    debugShowDecal = False
                    order = 99999
                }

            }
        }
		
        // Oh boy
        SpaceCenter
        {
            // Positioned overlooking a lake
            latitude = 0.795314087574037
			longitude = -58.3152938364619
			decalLatitude = 0.775314087574037
			decalLongitude = -58.3852938364619
            repositionRadiusOffset = 1235 // Decal difference is +5
            reorientFinalAngle = 150           // Rotation aligned to 270deg
            lodvisibleRangeMult = 6

            // Teshyr ground color #AD6242
            Material
            {
               grassColor = RGBA(173, 98, 66, 1)
            }
        }
    }
}

// Helps fix problems
@Kopernicus_config:HAS[@KSS2_Settings:HAS[#HomeSwitch[Teshyr]]]:AFTER[KOPERNICUS]
{
    %useManualMemoryManagement = True 
}